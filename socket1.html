<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      #content {
        width: 50vw;
        height: 50vh;
        background-color: pink;
      }
    </style>
  </head>

  <body>
    <button id="btn1">chat1</button>
    <button id="btn2">chat2</button>
    <button id="btn3">chat3</button>
    <div id="content"></div>
    <input type="text" id="msgInput" />
    <input type="submit" value="submit" , id="sub" />
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
  <script>
    const content = document.getElementById("content")
    const btn1 = document.getElementById("btn1")
    const btn2 = document.getElementById("btn2")
    const btn3 = document.getElementById("btn3")
    const input = document.getElementById("msgInput")
    const submit = document.getElementById("sub")
    const userId = 1

    submit.addEventListener("click", () => {
      const msg = input.value
      socket.emit("channelMsg", msg)
      input.value = ""
    })

    btn1.addEventListener("click", () => {
      socket.emit("joinChannel", "chat1")
      btn1.disabled = true
      btn2.disabled = false
      btn3.disabled = false
    })
    btn2.addEventListener("click", () => {
      socket.emit("joinChannel", "chat2")
      btn2.disabled = true
      btn1.disabled = false
      btn3.disabled = false
    })
    btn3.addEventListener("click", () => {
      socket.emit("joinChannel", "chat3")
      btn3.disabled = true
      btn1.disabled = false
      btn2.disabled = false
    })
    const socket = io("http://localhost:3001/287302522", {
      transports: ["websocket"],
    })
    let onlineChannelUser = {
      allOnlineUsers: new Set(),
    }
    socket.on("connect", () => {
      socket.on("guild_online_users", (newUserId) => {
        onlineChannelUser.allOnlineUsers = new Set([
          ...onlineChannelUser.allOnlineUsers,
          ...newUserId,
        ])
        console.log(onlineChannelUser)
      })

      socket.on("delete_guild_online_user", (oldUserId) => {
        onlineChannelUser.allOnlineUsers.delete(oldUserId)
        console.log(onlineChannelUser)
      })

      socket.on("channelNotice", (notice) => {
        console.log(notice)
      })

      socket.on("channel_online_user", (channel_online) => {
        onlineChannelUser = {
          ...onlineChannelUser,
          ...channel_online,
        }
        console.log(onlineChannelUser)
      })

      socket.on("update_channel_online_user", (newUserId, channelId) => {
        if (onlineChannelUser[channelId.toString()]) {
          onlineChannelUser[channelId.toString()].push(newUserId)
        } else {
          onlineChannelUser[channelId.toString()] = [newUserId]
        }
        console.log(onlineChannelUser)
      })

      socket.on("delete_channel_online_user", (userId, channelId) => {
        const position = onlineChannelUser[channelId.toString()].indexOf(userId)
        onlineChannelUser[channelId.toString()].splice(position, 1)
        console.log(onlineChannelUser)
      })

      socket.on("channelMsg", (data) => {
        console.log(data)
        let p = document.createElement("p")
        p.innerHTML = data
        content.appendChild(p)
      })

      socket.emit("baseInfo", userId)
    })
  </script>
</html>
